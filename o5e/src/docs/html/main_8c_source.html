<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>O5E: main.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>main.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*********************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">    @file main.c                                                              </span>
<a name="l00004"></a>00004 <span class="comment">    @date   October, 2011</span>
<a name="l00005"></a>00005 <span class="comment">    @brief  Open5xxxECU - calls init routines, creates tasks, starts scheduler to run them</span>
<a name="l00006"></a>00006 <span class="comment">        @note www.Open5xxxECU.org</span>
<a name="l00007"></a>00007 <span class="comment">    @version 1.1</span>
<a name="l00008"></a>00008 <span class="comment">    @copyright MIT License</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">**********************************************************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">/*</span>
<a name="l00013"></a>00013 <span class="comment">Copyright (c) 2011 Jon Zeeff</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">*/</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#define EXTERN</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#include &quot;main.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;cpu.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#define EXTERN</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#include &quot;variables.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;OS.h&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;eSCI_DMA.h&quot;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">// Note: CocoOS allows less critical tasks to run less frequently and prevents spagetti code caused by state machines</span>
<a name="l00034"></a>00034 <span class="comment">//       Currently it uses no interrupts and no preemption.  But it does use Duff&#39;s device - so no non-static local </span>
<a name="l00035"></a>00035 <span class="comment">//           variables in a task (elsewhere is fine).</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">// Declare tasks that you want to run here and add below</span>
<a name="l00038"></a>00038 <span class="keyword">extern</span> <span class="keywordtype">void</span> engine_task (<span class="keywordtype">void</span>);
<a name="l00039"></a>00039 <span class="keyword">extern</span> <span class="keywordtype">void</span> tuner_task (<span class="keywordtype">void</span>);
<a name="l00040"></a>00040 <span class="keyword">extern</span> <span class="keywordtype">void</span> LED_task(<span class="keywordtype">void</span>);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keywordtype">void</span> System_Init(<span class="keywordtype">void</span>); <span class="comment">// init routine</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">// OS housekeeping</span>
<a name="l00045"></a>00045 <span class="keyword">static</span> <span class="keywordtype">void</span> scheduler (<span class="keywordtype">void</span>);
<a name="l00046"></a>00046 <span class="keyword">static</span> uint8_t task_freq[N_TASKS];      <span class="comment">// how often to run, 1 = most often</span>
<a name="l00047"></a>00047 <span class="keyword">static</span> uint8_t task_id[N_TASKS];        <span class="comment">// tasks that have been created</span>
<a name="l00048"></a>00048 <span class="keyword">static</span> <span class="keywordtype">int</span> num_tasks=0;
<a name="l00049"></a>00049 <span class="keyword">static</span> Evt_t event;                                     <span class="comment">// dummy event</span>
<a name="l00050"></a>00050 <span class="keyword">static</span> uint8_t max_task_time;           <span class="comment">// longest that any task took</span>
<a name="l00051"></a>00051 <span class="keyword">static</span> uint32_t task_runs;                              <span class="comment">// how many task runs</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">/*************************************************************************************/</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057         <span class="comment">// Initialize the O5E system</span>
<a name="l00058"></a>00058         System_Init();
<a name="l00059"></a>00059         send_serial_A(<span class="stringliteral">&quot;O5E V1.1\r\n&quot;</span>,10);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#ifdef JZ</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>        <span class="keywordtype">void</span> generator(<span class="keywordtype">void</span>);
<a name="l00063"></a>00063         generator();
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>        
<a name="l00066"></a>00066         <span class="comment">// the code that we want to run repeatedly</span>
<a name="l00067"></a>00067         <span class="comment">// Note: order by priority</span>
<a name="l00068"></a>00068         <span class="comment">// Note: all tasks must &quot;suspend()&quot; or &quot;wait()&quot; at least every 1/2 msec, preferably more often</span>
<a name="l00069"></a>00069         <span class="comment">// CRITICAL: tasks cannot have non-static local variables and cannot use switch statements!</span>
<a name="l00070"></a>00070         <span class="comment">// pick task_freq from this list: 1,2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="comment">// TODO - put back in - crashes my board</span>
<a name="l00073"></a>00073         <span class="comment">//task_id[num_tasks] = task_create(engine_task,num_tasks+128,0,0,0);    // create the task</span>
<a name="l00074"></a>00074         <span class="comment">//task_freq[num_tasks++] = 1;   // set how often we want it to run (1 = most often), should be a prime #</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076         <span class="comment">//task_id[num_tasks] = task_create(tuner_task,num_tasks+128,0,0,0);     // create the task</span>
<a name="l00077"></a>00077         <span class="comment">//task_freq[num_tasks++] = 3;   // set how often we want it to run (1 = most often), should be a prime #</span>
<a name="l00078"></a>00078         
<a name="l00079"></a>00079         task_id[num_tasks] = task_create(LED_task,253,0,0,0);                   <span class="comment">// create the task - second lowest priority</span>
<a name="l00080"></a>00080         task_freq[num_tasks++] = 47;    <span class="comment">// set how often we want it to run (1 = most often), should be a prime #</span>
<a name="l00081"></a>00081         <span class="comment">// =====  add more here ======</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083         <span class="comment">// this task doesn&#39;t change -  always last and lowest priority</span>
<a name="l00084"></a>00084         task_create(scheduler,254,0,0,0);       <span class="comment">// task which decides which other tasks can run - lowest priority</span>
<a name="l00085"></a>00085         <span class="keyword">event</span> = event_create();                 <span class="comment">// dummy event</span>
<a name="l00086"></a>00086         
<a name="l00087"></a>00087         os_start();   <span class="comment">// never returns</span>
<a name="l00088"></a>00088         <span class="keywordflow">return</span> 0;    
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">/*************************************************************************************/</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">// Move Along, Nothing To See Here</span>
<a name="l00094"></a>00094 <span class="comment">// Just trust that if you added the right two lines above, your task will be run</span>
<a name="l00095"></a>00095 <span class="comment">// </span>
<a name="l00096"></a>00096 <span class="comment">// Determine which tasks are ready to run</span>
<a name="l00097"></a>00097 <span class="comment">// CocoOS is non-preemptive and uses no interrupts.  This implements round-robin, 1/n frequency, msec clock and events</span>
<a name="l00098"></a>00098 <span class="comment">// This task is always ready to run, but it has the lowest priority. </span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="keyword">static</span> <span class="keywordtype">void</span> scheduler(<span class="keywordtype">void</span>) {
<a name="l00101"></a>00101         <span class="keyword">static</span> uint_fast8_t task_count[N_TASKS];                <span class="comment">// tracks when to run each task</span>
<a name="l00102"></a>00102         <span class="keyword">static</span> uint32_t prev_clock;
<a name="l00103"></a>00103         <span class="keyword">static</span> uint_fast8_t i;
<a name="l00104"></a>00104         
<a name="l00105"></a>00105         task_open();                                    <span class="comment">// NOTE:  no non-static local variables allowed</span>
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         <span class="comment">// spread counters around so all x tasks don&#39;t run at the same time</span>
<a name="l00108"></a>00108         <span class="keywordflow">for</span> (i = 0; i &lt; N_TASKS; ++i)
<a name="l00109"></a>00109         task_count[i] = 97*i;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         prev_clock = clock();   <span class="comment">// init to current value</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="keywordflow">for</span> (;;) {
<a name="l00114"></a>00114                 <span class="comment">// go through all tasks and resume those that should be run</span>
<a name="l00115"></a>00115                 <span class="keywordflow">for</span> (i = 0; i &lt; num_tasks; ++i) {
<a name="l00116"></a>00116                         <span class="keywordflow">if</span> (++task_count[i] % task_freq[i] == 0) {      <span class="comment">// 1/n scheduling</span>
<a name="l00117"></a>00117                                 os_task_resume(task_id[i]);                     <span class="comment">// set task to run if not waiting on anything else</span>
<a name="l00118"></a>00118                                 event_signal(event);                            <span class="comment">// dummy to cause task change </span>
<a name="l00119"></a>00119                         }                
<a name="l00120"></a>00120 
<a name="l00121"></a>00121                         <span class="comment">// update 1 msec clocks - OS and simple variable</span>
<a name="l00122"></a>00122                         <span class="comment">// TODO consider using an angle clock instead</span>
<a name="l00123"></a>00123                         <span class="keywordflow">if</span> ((((clock() -  prev_clock)) &amp; 0xffffff) &gt; TICKS_PER_MSEC) {  <span class="comment">// it&#39;s a 24 bit clock</span>
<a name="l00124"></a>00124                                 ++msec_clock;
<a name="l00125"></a>00125                                 os_task_tick();               
<a name="l00126"></a>00126                                 prev_clock = (prev_clock + TICKS_PER_MSEC) &amp; 0xffffff;   <span class="comment">// increment previous</span>
<a name="l00127"></a>00127                         }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129                         <span class="comment">// TODO test and set other events here</span>
<a name="l00130"></a>00130 
<a name="l00131"></a>00131                         ++task_runs;                    <span class="comment">// track this for debug</span>
<a name="l00132"></a>00132                         <span class="comment">// TODO - track %CPU for each task</span>
<a name="l00133"></a>00133                 } <span class="comment">// for</span>
<a name="l00134"></a>00134         } <span class="comment">// for ever</span>
<a name="l00135"></a>00135         task_close();  <span class="comment">// never reached</span>
<a name="l00136"></a>00136 }  <span class="comment">// scheduler()</span>
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="comment">/*************************************************************************************/</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="comment">// Routine to record an error</span>
<a name="l00141"></a>00141 <span class="keywordtype">void</span> system_error(int16_t code, <span class="keywordtype">char</span> *file, uint16_t line, <span class="keywordtype">char</span> *note) 
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143         last_error = code;
<a name="l00144"></a>00144         <span class="comment">//printf(&quot;err: %d %s %d %s\r\n&quot;,code, file, line, note);        // log error</span>
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="comment">/*************************************************************************************/</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#include &quot;cpu.h&quot;</span>
<a name="l00150"></a>00150 <span class="preprocessor">#include &quot;FreeScale/FSutil.h&quot;</span>
<a name="l00151"></a>00151 <span class="preprocessor">#include &quot;eSCI_OPS.h&quot;</span>
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="preprocessor">#include &quot;mpc5500_ccdcfg.h&quot;</span>
<a name="l00154"></a>00154 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <span class="keywordtype">string</span>[80];
<a name="l00157"></a>00157  
<a name="l00158"></a>00158 <span class="comment">// Task to verify that OS is running - flash a LED</span>
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="keywordtype">void</span> LED_task(<span class="keywordtype">void</span>)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162         task_open();     <span class="comment">// NOTE:  no non-static local variables allowed</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         task_wait(500);
<a name="l00165"></a>00165         send_serial_B(<span class="stringliteral">&quot;O5E serial port B\r\n&quot;</span>,19);  <span class="comment">// alternate serial port</span>
<a name="l00166"></a>00166         send_serial_A(<span class="stringliteral">&quot;O5E serial port A\r\n&quot;</span>,19); 
<a name="l00167"></a>00167         sprintf(<span class="keywordtype">string</span>,<span class="stringliteral">&quot;Compiled %s %s\r\n&quot;</span>,__DATE__, __TIME__);
<a name="l00168"></a>00168         send_serial_A(<span class="keywordtype">string</span>,strlen(<span class="keywordtype">string</span>));
<a name="l00169"></a>00169         
<a name="l00170"></a>00170         <span class="comment">// init LED pin</span>
<a name="l00171"></a>00171         init_LED(LED_PIN, 0);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="comment">// flash every second</span>
<a name="l00174"></a>00174         <span class="keywordflow">for</span> (;;) {
<a name="l00175"></a>00175                 invert_LED(LED_PIN);
<a name="l00176"></a>00176                 task_wait(1000);       <span class="comment">// delay 1000 msec</span>
<a name="l00177"></a>00177         } <span class="comment">// for ever</span>
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         task_close();  <span class="comment">// never reached</span>
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 } <span class="comment">// LED_task()</span>
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="comment">/*************************************************************************************/</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Nov 14 12:33:03 2011 for O5E by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
